# Database Architecture - Venue Ninja 🗄️

This document outlines the database architecture, migration strategy, and connection management for the Venue Ninja application.

---

## 🏗️ Architecture Overview

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Spring Boot   │    │   HikariCP      │    │   PostgreSQL    │
│   Application   │◄──►│   Connection    │◄──►│   Database      │
│                 │    │   Pool          │    │                 │
│ • JPA Entities  │    │ • SSL Mode      │    │ • Venues        │
│ • Repositories  │    │ • Pool Size: 10 │    │ • Seat Recs     │
│ • Services      │    │ • Timeout: 30s  │    │ • Migrations    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

---

## 📊 Database Schema

### Core Tables

#### `venue` Table
```sql
CREATE TABLE venue (
    id VARCHAR(255) PRIMARY KEY,
    name VARCHAR(255) NOT NULL
);
```

**Purpose**: Stores venue information
- `id`: Unique identifier (e.g., "msg", "yankee", "citi")
- `name`: Human-readable venue name

#### `seat_recommendation` Table
```sql
CREATE TABLE seat_recommendation (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    venue_id VARCHAR(255) NOT NULL,
    section VARCHAR(255),
    category VARCHAR(255),
    reason VARCHAR(255),
    estimated_price VARCHAR(255),
    tip VARCHAR(255),
    FOREIGN KEY (venue_id) REFERENCES venue(id)
);
```

**Purpose**: Stores seat recommendations for each venue
- `id`: Auto-generated primary key
- `venue_id`: Foreign key to venue table
- `section`: Seat section (e.g., "104", "200")
- `category`: Seat category (e.g., "Lower Bowl", "Upper Bowl")
- `reason`: Why this seat is recommended
- `estimated_price`: Price estimate
- `tip`: Additional advice for the seat

---

## 🔄 Migration Strategy

### Development Evolution

#### Phase 1: In-Memory Data (Initial)
```java
// Hardcoded mock data in service layer
private final Map<String, Venue> venues = Map.of(
    "msg", new Venue("msg", "Madison Square Garden", recommendations),
    "yankee", new Venue("yankee", "Yankee Stadium", recommendations)
);
```

**Pros**: Fast development, no database setup
**Cons**: No persistence, data resets on restart

#### Phase 2: H2 In-Memory Database (Testing)
```properties
# application-test.properties
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driver-class-name=org.h2.Driver
spring.jpa.hibernate.ddl-auto=create-drop
```

**Pros**: Database-like behavior, fast tests
**Cons**: Still no persistence, H2-specific features

#### Phase 3: PostgreSQL Production Database
```properties
# application-production.properties
spring.datasource.url=jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME}?sslmode=require
spring.datasource.username=${DB_USER}
spring.datasource.password=${DB_PASSWORD}
```

**Pros**: Real persistence, production-ready, SSL support
**Cons**: Requires external database setup

---

## 🔌 Connection Management

### HikariCP Configuration

```properties
# Connection Pool Settings
spring.datasource.hikari.maximum-pool-size=10
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.connection-timeout=30000
spring.datasource.hikari.idle-timeout=600000
spring.datasource.hikari.max-lifetime=1800000
```

**Benefits**:
- **Performance**: Connection reuse reduces overhead
- **Reliability**: Automatic connection validation
- **Scalability**: Configurable pool size for load

### SSL Configuration

```properties
# Production SSL Settings
spring.datasource.url=jdbc:postgresql://host:port/db?sslmode=require
```

**Security Features**:
- **Encryption**: All data in transit is encrypted
- **Authentication**: Server certificate validation
- **Compliance**: Meets security standards

---

## 🌍 Environment Configuration

### Development Environment
```properties
# application.properties (default)
spring.datasource.url=jdbc:postgresql://localhost:5432/venueninja
spring.datasource.username=postgres
spring.datasource.password=
spring.jpa.hibernate.ddl-auto=create
spring.jpa.show-sql=true
```

### Test Environment
```properties
# application-test.properties
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driver-class-name=org.h2.Driver
spring.jpa.hibernate.ddl-auto=create-drop
spring.jpa.show-sql=false
```

### Production Environment
```properties
# application-production.properties
spring.datasource.url=${DATABASE_URL:jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:venueninja}?sslmode=require}
spring.datasource.username=${DB_USER:}
spring.datasource.password=${DB_PASSWORD:}
spring.jpa.hibernate.ddl-auto=create
spring.jpa.show-sql=false
```

---

## 🧪 Database Testing Strategy

### Unit Tests (H2)
```java
@SpringBootTest
@ActiveProfiles("test")
class VenueServiceTest {
    // Tests run against H2 in-memory database
    // Fast execution, isolated environment
}
```

### Integration Tests (H2)
```java
@DataJpaTest
@ActiveProfiles("test")
class VenueRepositoryTest {
    // Tests JPA repository operations
    // Validates entity mappings and queries
}
```

### External Database Tests (PostgreSQL)
```java
@Test
void testExternalDatabaseConnection() throws SQLException {
    // Tests actual production database connectivity
    // Validates environment variables and SSL configuration
}
```

---

## 🚀 Deployment Challenges & Solutions

### Challenge 1: URL Encoding Issues
**Problem**: Special characters in database passwords caused connection failures
```bash
# ❌ Failed - password with special characters
DATABASE_URL=postgresql://user:pass@word@host:5432/db
```

**Solution**: Use individual environment variables
```bash
# ✅ Works - separate username and password
DB_USER=user
DB_PASSWORD=pass@word
```

### Challenge 2: SSL Configuration
**Problem**: Render requires SSL connections for security
```bash
# ❌ Failed - no SSL
jdbc:postgresql://host:5432/db
```

**Solution**: Add SSL mode parameter
```bash
# ✅ Works - SSL enabled
jdbc:postgresql://host:5432/db?sslmode=require
```

### Challenge 3: Environment Variable Management
**Problem**: Different deployment environments need different configurations

**Solution**: Profile-based configuration with fallbacks
```properties
# Supports both individual variables and single URL
spring.datasource.url=${DATABASE_URL:jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:venueninja}?sslmode=require}
```

---

## 📈 Performance Optimization

### Connection Pooling Benefits
- **Reduced Latency**: Reuse existing connections
- **Resource Management**: Limit concurrent connections
- **Fault Tolerance**: Automatic connection recovery

### Query Optimization
```java
// Efficient JPA queries
@Repository
public interface VenueRepository extends JpaRepository<Venue, String> {
    // Spring Data JPA generates optimized queries
    // Automatic pagination and sorting support
}
```

### Indexing Strategy
```sql
-- Primary key indexes (automatic)
CREATE INDEX idx_seat_recommendation_venue_id ON seat_recommendation(venue_id);

-- Foreign key indexes for performance
CREATE INDEX idx_seat_recommendation_category ON seat_recommendation(category);
```

---

## 🔒 Security Considerations

### Database Security
- **SSL Connections**: All production traffic encrypted
- **Environment Variables**: Sensitive data not in code
- **Connection Pooling**: Prevents connection exhaustion attacks

### Access Control
- **Read-Only Operations**: API only performs SELECT operations
- **No User Data**: No PII stored in database
- **Audit Trail**: Database logs for monitoring

---

## 🔮 Future Enhancements

### Planned Improvements
1. **Database Migrations**: Flyway or Liquibase for schema versioning
2. **Caching Layer**: Redis for frequently accessed data
3. **Read Replicas**: Separate read/write databases for scaling
4. **Backup Strategy**: Automated database backups
5. **Monitoring**: Database performance metrics

### Scalability Considerations
- **Horizontal Scaling**: Stateless application design
- **Database Sharding**: Multi-tenant architecture ready
- **CDN Integration**: Static content delivery optimization

---

## 📚 Resources

- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [Spring Data JPA Reference](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/)
- [HikariCP Configuration](https://github.com/brettwooldridge/HikariCP)
- [Render PostgreSQL Setup](https://render.com/docs/databases) 